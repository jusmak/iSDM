---
title: "SDM: data combining "
author: "Jussi MÃ¤kinen"
date: "12/22/2020"
output:
  html_document: default
  pdf_document: default
---

## Objective of the document

In this study I build and estimate SDMs with two different approaches wrt. species data. In the first approach I estimate the model parameters which govern the species log-intensity using presence-only observations. In the second approach I use a combination of presence-only and presence-absence observations.
The observation types differ from each other regarding the variation of sampling intensity, the type of observations, and the area covered by sampling. Presence-only observations originate from an uncontrolled sampling process, where sampling intensity varies spatially and among species. There are no  absence-observations, but the sampling covers a large area. Presence-absence observations originate from a systematic sampling process, where the sampling intensity is spatially constant but may vary between species. Sampling creates certain absence observations but covers a relatively small area.

I estimate SDMs of the combined data sets by using an empirical Bayesian inference. I apply the Bayes rule for integrating prior information about model parameters and derive point-estimates to model parameters with Laplace-approximation. This method approximates the posterior distribution with a Normal distribution so that the mean of the approximate distribution is the mode of the posterior distribution. Standard error of the approximation is computed based on the Hessian matrix of the negative log-likelihood function.

The inference of the presence-only data models is based on fully hierarchical Bayesian approach. I changed the inference to the second approach (presence-only + presence-absence data) to save computational time. However, the posterior mean and mode should be quite close to each other.

The document has three parts:
1. Data: Introduction to the presence-absence data set.
2. Model: Inference of the combined likelihood function.
3. Results: Accuracy of the fitted model and predictive maps.

The study species are marvelous spatuletail (Loddigesia mirabilis) and white-booted racket-tail (Ocreatus underwoodii).

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

.wd <- 'C:/Users/OMISTAJA/Documents/Hummingbird_project'
.seed <- 5326
set.seed(.seed)
lib_path <- .libPaths()[1]
suppressPackageStartupMessages({
  library(raster, lib.loc=lib_path)
  library(glmnet, lib.loc=lib_path)
  library(pracma, lib.loc=lib_path)
  library(ppmlasso, lib.loc=lib_path)
  library(rstan, lib.loc=lib_path)
  library(bayesplot, lib.loc=lib_path)
  library(rstanarm, lib.loc=lib_path)
  library(ggplot2, lib.loc=lib_path)
  library(dismo, lib.loc=lib_path)
  library(dplyr, lib.loc=lib_path)
  library(loo, lib.loc=lib_path)
  library(caret, lib.loc=lib_path)
  library(pROC, lib.loc=lib_path)
  library(flexclust, lib.loc=lib_path)
  library(RColorBrewer, lib.loc=lib_path)
  library(knitr)
})

#Set SDM parameters
species_list = c("Loddigesia_mirabilis", "Ocreatus_underwoodii", "Oreotrochilus_leucopleurus") #
thinning = FALSE
thin_mark <- ifelse(thinning, "thin", "not_thin")
n_samp = 500
target_n_obs = 50000
weights_area <- FALSE
weights_mark <- ifelse(weights_area, "wa", "not_wa")


#Define color schemes
mycol <- rgb(0, 0, 255, max = 255, alpha = 75, names = "blue50")
col_temp <- colorRamp("gray")
mycol_2 <- col_temp(1)/255

cm.cols1.1=function(x,bias=1) { colorRampPalette(c('grey90','grey90','grey90','grey90','grey60','grey60','grey60','steelblue4','steelblue1','gold','gold','red1','red1','red4','red4'),bias=bias)(x)
}
col_pal <- cm.cols1.1(50)
```
## 1. Data: Introduction to the presence-absence data set.

Species presence-absence data were mentioned in the earlier document for exploring hummingbird SDMs. The data sets are based on species inventories, where species have been surveyed with constant sampling methods and sampling intensity across the sites. This means that absence sites are actual or close to true absences. Number of inventory survey sites varies among species.

```{r observations_1, echo=FALSE}

## Marvelous spatuletail
.species <- species_list[1]

#set scale out according to the target_n_obs
domain_temp <- stack(paste(.wd,"/Data/Domains/", .species, ".tif", sep = ''))
scale_out <- round(sqrt(sum(!is.na(values(domain_temp[[1]])))/target_n_obs))

#Load data
load(paste(.wd, "/Compiled_data/", .species, '_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '.R', sep = ''))

#visualize the species observations and the offsets
#load raster
raster_cov_temp <- stack(paste(.wd,"Data/Environment/Chelsa_SA.tif", sep = '/'))

#load geographic extent
domain_temp <- stack(paste(.wd,"/Data/Domains/", .species, ".tif", sep = ''))

raster_cov_temp <- crop(raster_cov_temp, domain_temp)
values(raster_cov_temp)[is.na(values(domain_temp)[,2]),] <- NA

#rescale raster
raster_cov_temp <- raster::aggregate(raster_cov_temp, fact = scale_out)

#find cells which have all covariate values
cov_df <- as.data.frame(raster_cov_temp, na.rm = FALSE)
rows_na <- apply(cov_df,1,anyNA)
ind_na <- which(rows_na==FALSE)

#create a background
background <- raster_cov_temp$Chelsa_SA.1

raster_cov_temp <- stack(paste(.wd,"Data/Environment/Chelsa_SA.tif", sep = '/'))
extent_temp <- c(-4e6, 5.5e6, -7.5e6, 2e6)
raster_cov_temp <- crop(raster_cov_temp, extent_temp)
background_domain <- raster_cov_temp$Chelsa_SA.1



#Plot three maps
par(mfrow = c(1,3), cex.main = 1.5, mai = c(0.1,0.1,0.2,0.1))
plot(background_domain, axes = F, box = FALSE, main = "Study domain", col = mycol_2, legend = FALSE)
plot(background, axes = F, box = FALSE, legend = FALSE, add = TRUE, col = mycol)

#PO points
sp_occ <- data$training_data$coordinates[data$training_data$response==1,]
sp_occ <- cbind(sp_occ[,1]*1000 + data$training_data$min_coordinates[1],
                sp_occ[,2]*1000 + data$training_data$min_coordinates[2])

plot(background, axes = F, box = FALSE, legend = FALSE, main = paste("PO-data (", as.character(sum(data$training_data$response)), ')', sep = ''), cex = 1.7, col = mycol)
points(sp_occ, cex = 1.7, pch = 20, col = "gray10")
legend(x = 2.42e5, y = -2.6e6, cex = 1.5, legend = "occurrence", col = "gray10", pch = 20)


#PA points
sp_occ <- data$inventory_data$coordinates[data$inventory_data$response==1,]
sp_occ <- cbind(sp_occ[,1]*1000 + data$training_data$min_coordinates[1],
                sp_occ[,2]*1000 + data$training_data$min_coordinates[2])

col <- ifelse(data$inventory_data$response==1, "red", "black")

plot(domain_temp[[2]], axes = F, box = FALSE, legend = FALSE, main = paste("PA-data (", as.character(length(data$inventory_data$response)), ")", sep = ''),
     cex = 1.7, col = mycol)
points(sp_occ, cex = 1, pch = 20, col = col)
legend(x = .5e5, y = -2.5e6, cex = 1.5,  legend = c(paste("presence (", sum(data$inventory_data$response), ")", sep = ''),paste("absence (", sum(data$inventory_data$response==0), ")", sep = '')), col = c("red", "black"), pch = 20)

```

Fig. 1. Study domain and presence-only and presence-absence observations of marvelous spatuletail.

```{r observations_2, echo=FALSE, message=FALSE}

## White-booted racket-tail
.species <- species_list[2]

#set scale out according to the target_n_obs
domain_temp <- stack(paste(.wd,"/Data/Domains/", .species, ".tif", sep = ''))
scale_out <- round(sqrt(sum(!is.na(values(domain_temp[[1]])))/target_n_obs))

#Load data
load(paste(.wd, "/Compiled_data/", .species, '_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '.R', sep = ''))

#visualize the species observations and the offsets
#load raster
raster_cov_temp <- stack(paste(.wd,"Data/Environment/Chelsa_SA.tif", sep = '/'))

#load geographic extent
domain_temp <- stack(paste(.wd,"/Data/Domains/", .species, ".tif", sep = ''))

raster_cov_temp <- crop(raster_cov_temp, domain_temp)
values(raster_cov_temp)[is.na(values(domain_temp)[,2]),] <- NA

#rescale raster
raster_cov_temp <- raster::aggregate(raster_cov_temp, fact = scale_out)

#find cells which have all covariate values
cov_df <- as.data.frame(raster_cov_temp, na.rm = FALSE)
rows_na <- apply(cov_df,1,anyNA)
ind_na <- which(rows_na==FALSE)

#create a background
background <- raster_cov_temp$Chelsa_SA.1

raster_cov_temp <- stack(paste(.wd,"Data/Environment/Chelsa_SA.tif", sep = '/'))
extent_temp <- c(-4e6, 5.5e6, -7.5e6, 2e6)
raster_cov_temp <- crop(raster_cov_temp, extent_temp)
background_domain <- raster_cov_temp$Chelsa_SA.1



#Plot three maps
par(mfrow = c(1,3), cex.main = 1.5, mai = c(0.1,0.1,0.2,0.1))
plot(background_domain, axes = F, box = FALSE, main = "Study domain", col = mycol_2, legend = FALSE)
plot(background, axes = F, box = FALSE, legend = FALSE, add = TRUE, col = mycol)

#PO points
sp_occ <- data$training_data$coordinates[data$training_data$response==1,]
sp_occ <- cbind(sp_occ[,1]*1000 + data$training_data$min_coordinates[1],
                sp_occ[,2]*1000 + data$training_data$min_coordinates[2])

plot(background, axes = F, box = FALSE, legend = FALSE, main = paste("PO-data (", as.character(sum(data$training_data$response)), ')', sep = ''), cex = 1.7, col = mycol)
points(sp_occ, cex = 1.7, pch = 20, col = "gray10")
legend(x = -7e5, y = 1e6, cex = 1.5, legend = "occurrence", col = "gray10", pch = 20)


#PA points
sp_occ <- data$inventory_data$coordinates[data$inventory_data$response==1,]
sp_occ <- cbind(sp_occ[,1]*1000 + data$training_data$min_coordinates[1],
                sp_occ[,2]*1000 + data$training_data$min_coordinates[2])

col <- ifelse(data$inventory_data$response==1, "red", "black")

plot(domain_temp[[2]], axes = F, box = FALSE, legend = FALSE, main = paste("PA-data (", as.character(length(data$inventory_data$response)), ")", sep = ''),
     cex = 1.7, col = mycol)
points(sp_occ, cex = 1, pch = 20, col = col)
legend(x = -17e5, y = 1.2e6, cex = 1.5,  legend = c(paste("presence (", sum(data$inventory_data$response), ")", sep = ''),paste("absence (", sum(data$inventory_data$response==0), ")", sep = '')), col = c("red", "black"), pch = 20)

```

Fig. 2. Study domain and presence-only and presence-absence observations of white-booted racket-tail.


## 2. Model: Inference of the combined likelihood function.

### 2.1. Poisson point process

A point process models jointly the total number and spatial locations of species occurrence points. Here, I applied inhomogeneous Poisson point process, which assumes that locations of species occurrences are independently distributed and their sum over the study area is Poisson distributed. The locations of species occurrences depend on the species intensity (=areal density) which varies spatially.
In this exploration I explained variation of the species intensity with environmental covariates.
Log-likelihood of a Poisson point process is defined as:
$$ l(\lambda; s_{PO}) = \sum_{i=1}^{I} ln(\lambda(s_i)) - \int_A \lambda(s)\mathrm{d}s,$$
where lambda is for the species intensity, s a spatial location of a presence-only observation, <em>I</em> the total number of species observations and <em>A</em> the study area. However, the integral over the study area cannot be computed and that needs to be approximated by discretizing the study area. High number of quadrature points (> 10000) and appropriate sampling weights improve estimation accuracy of the model.

### 2.2. Combined likelihood functions

The strength of combining data sets is that the data sets can be fitted with different likelihood functions, which share parameters for the covariate effects. I assume that a presence-only observation is a point-wise observation of a single species individual, and its location can be modeled conditioned on the species intensity surface across the study area. Likelihood of the presence-only data can be accessed through Poisson distribution. In the presence-absence data, a presence-observation does not inform about the number of the species individuals but only about the presence of at least one individual. Such data type cannot be modeled as Poisson distributed since the number of presence sites is not the same as the species population size, as it theoretically is when modeling presence-only data. Species occurrence depends also on the size of the sampling unit. By increasing the unit size, probability for detecting a species increases. Thus, species occurrence is not a point-wise observation, but species occurrence is an integral of species individuals over the sampling unit. I follow the approach of Dorazio (2014) and model species presence-absence observations as Bernoulli distributed. I link presence probability of a species with a complementary log-log link to species intensity. In this way we can estimate covariate effects jointly with presence-only and presence-absence data. Log-likelihood of the presence-absence data is

$$ l(\lambda; s_{PA}) = \sum_{j=1}^{J} y_i log(1-e^{-exp(\lambda(s_i))}) + (1-y_i)exp(\lambda(s_i)),$$

where s denotes a spatial location of an inventory site, <em>J</em> total number of inventory sites, and y a presence-absence observation. I compute the combined log-likelihood as a sum of the likelihood functions for presence-only and presence-absence data sets so that

$$ l(\lambda; s_{PO}, s_{PA}) = l(\lambda; s_{PO}) + l(\lambda; s_{PA}). $$

Species intensity is modeled as a log linear model so that:
$$ log(\lambda) = \alpha + \sum_{k=1}^{K} x_k^T*\beta_k, $$
where alpha is a model intercept, beta is a linear weight related to a covariate and K is the number of covariates and their second order polynomials. The offset information is included in the log-linear model as a fixed variable. The varying average sampling effort between presence-only and presence-absence data sets was accounted for with an extra intercept parameter in the intensity function for presence-absence data points. Thus, I assume that both data sets have been sampled with spatially constant sampling efforts, but the efforts differ by a constant.

### 2.3. Inference
I fitted the model to estimate posterior distributions of the unknown parameters. Each parameter was assigned an uninformative prior so that:
$$ \alpha \sim N(0,10) $$
$$ \beta_k \sim N(0,10) $$
The models were fitted with STAN-software applying Laplace approximation.

## 3. Results: Accuracy of the fitted model and predictive maps.

### 3.1. Comparison of the parameter estimates fitted with PO-data alone or by combinign PO and PA-data sets


```{r posterior predictive distribution 1, echo = FALSE}
## Marvelous spatuletail
.species <- species_list[1]

#load full HB samples
load(paste(.wd, "/Model_fits/", .species, '_fits_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '_m_cat_', 1, '.RData', sep = ''))

#take samples of posterior distributions
HB_samples <- lapply(model_fits$HB_model, as.matrix)

#load point estimates
load(paste(.wd, "/Model_fits/", .species, '_fits_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '_m_cat_', 3, '.RData', sep = ''))

#take point estimates
point_est <- lapply(model_fits$fit_hb_comb_all, function(x) cbind(x$coefficient[c(1,3:length(x$coefficient))], x$lik))

plot_title <- list(ggtitle("No offset: Posterior distributions",
                      "with medians and 80% intervals and point estimates (red line)"),
                   ggtitle("Expert range map: Posterior distributions",
                      "with medians and 80% intervals and point estimates (red line)"),
                   ggtitle("Elevation: Posterior distributions",
                      "with medians and 80% intervals and point estimates (red line)"),
                   ggtitle("Expert range map + elevation: Posterior distributions",
                      "with medians and 80% intervals and point estimates (red line)"))


i=1

posterior <- HB_samples[[i]]
p_estimate <- point_est[[i]]
names(p_estimate) <- NULL
colnames(posterior) <- c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2', 'Lik.')

p <- mcmc_areas(posterior,
       pars = c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2'),
       prob = 0.8) + plot_title[[i]]

p + geom_segment(aes(x = p_estimate[1], xend = p_estimate[1], y = 8.8, yend = 9.7), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[2], xend = p_estimate[2], y = 7.8, yend = 8.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[3], xend = p_estimate[3], y = 6.8, yend = 7.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[4], xend = p_estimate[4], y = 5.8, yend = 6.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[5], xend = p_estimate[5], y = 4.8, yend = 5.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[6], xend = p_estimate[6], y = 3.8, yend = 4.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[7], xend = p_estimate[7], y = 2.8, yend = 3.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[8], xend = p_estimate[8], y = 1.8, yend = 2.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[9], xend = p_estimate[9], y = .8, yend = 2.1), color = "red", linetype = 2)

```

Figure 3. Marvelous spatuletail, no offset information: models fitted with solely presence-only observations are shown as sampled posterior distributions. Models fitted with presence-only and presence-absence observations are shown as point estimates.

```{r posterior predictive distribution 2, echo = FALSE}
## Marvelous spatuletail
i=2

posterior <- HB_samples[[i]]
p_estimate <- point_est[[i]]
names(p_estimate) <- NULL
colnames(posterior) <- c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2', 'Lik.')

p <- mcmc_areas(posterior,
       pars = c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2'),
       prob = 0.8) + plot_title[[i]]

p + geom_segment(aes(x = p_estimate[1], xend = p_estimate[1], y = 8.8, yend = 9.7), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[2], xend = p_estimate[2], y = 7.8, yend = 8.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[3], xend = p_estimate[3], y = 6.8, yend = 7.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[4], xend = p_estimate[4], y = 5.8, yend = 6.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[5], xend = p_estimate[5], y = 4.8, yend = 5.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[6], xend = p_estimate[6], y = 3.8, yend = 4.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[7], xend = p_estimate[7], y = 2.8, yend = 3.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[8], xend = p_estimate[8], y = 1.8, yend = 2.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[9], xend = p_estimate[9], y = .8, yend = 2.1), color = "red", linetype = 2)

```

Figure 4. Marvelous spatuletail, expert range map: models fitted with solely presence-only observations are shown as sampled posterior distributions. Models fitted with presence-only and presence-absence observations are shown as point estimates.

```{r posterior predictive distribution 3, echo = FALSE}
## Marvelous spatuletail
i=3

posterior <- HB_samples[[i]]
p_estimate <- point_est[[i]]
names(p_estimate) <- NULL
colnames(posterior) <- c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2', 'Lik.')

p <- mcmc_areas(posterior,
       pars = c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2'),
       prob = 0.8) + plot_title[[i]]

p + geom_segment(aes(x = p_estimate[1], xend = p_estimate[1], y = 8.8, yend = 9.7), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[2], xend = p_estimate[2], y = 7.8, yend = 8.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[3], xend = p_estimate[3], y = 6.8, yend = 7.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[4], xend = p_estimate[4], y = 5.8, yend = 6.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[5], xend = p_estimate[5], y = 4.8, yend = 5.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[6], xend = p_estimate[6], y = 3.8, yend = 4.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[7], xend = p_estimate[7], y = 2.8, yend = 3.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[8], xend = p_estimate[8], y = 1.8, yend = 2.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[9], xend = p_estimate[9], y = .8, yend = 2.1), color = "red", linetype = 2)

```

Figure 5. Marvelous spatuletail, elevation: models fitted with solely presence-only observations are shown as sampled posterior distributions. Models fitted with presence-only and presence-absence observations are shown as point estimates.

```{r posterior predictive distribution 4, echo = FALSE}
## Marvelous spatuletail
i=4

posterior <- HB_samples[[i]]
p_estimate <- point_est[[i]]
names(p_estimate) <- NULL
colnames(posterior) <- c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2', 'Lik.')

p <- mcmc_areas(posterior,
       pars = c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2'),
       prob = 0.8) + plot_title[[i]]

p + geom_segment(aes(x = p_estimate[1], xend = p_estimate[1], y = 8.8, yend = 9.7), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[2], xend = p_estimate[2], y = 7.8, yend = 8.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[3], xend = p_estimate[3], y = 6.8, yend = 7.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[4], xend = p_estimate[4], y = 5.8, yend = 6.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[5], xend = p_estimate[5], y = 4.8, yend = 5.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[6], xend = p_estimate[6], y = 3.8, yend = 4.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[7], xend = p_estimate[7], y = 2.8, yend = 3.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[8], xend = p_estimate[8], y = 1.8, yend = 2.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[9], xend = p_estimate[9], y = .8, yend = 2.1), color = "red", linetype = 2)

```

Figure 6. Marvelous spatuletail, expert range map and elevation: models fitted with solely presence-only observations are shown as sampled posterior distributions. Models fitted with presence-only and presence-absence observations are shown as point estimates.

```{r posterior predictive distribution 5, echo = FALSE}
## White-booted racket-tail
.species <- species_list[2]

#load full HB samples
load(paste(.wd, "/Model_fits/", .species, '_fits_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '_m_cat_', 1, '.RData', sep = ''))

#take samples of posterior distributions
HB_samples <- lapply(model_fits$HB_model, as.matrix)

#load point estimates
load(paste(.wd, "/Model_fits/", .species, '_fits_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '_m_cat_', 3, '.RData', sep = ''))

#take point estimates
point_est <- lapply(model_fits$fit_hb_comb_all, function(x) cbind(x$coefficient[c(1,3:length(x$coefficient))], x$lik))

plot_title <- list(ggtitle("No offset: Posterior distributions",
                      "with medians and 80% intervals and point estimates (red line)"),
                   ggtitle("Expert range map: Posterior distributions",
                      "with medians and 80% intervals and point estimates (red line)"),
                   ggtitle("Elevation: Posterior distributions",
                      "with medians and 80% intervals and point estimates (red line)"),
                   ggtitle("Expert range map + elevation: Posterior distributions",
                      "with medians and 80% intervals and point estimates (red line)"))


i=1

posterior <- HB_samples[[i]]
p_estimate <- point_est[[i]]
names(p_estimate) <- NULL
colnames(posterior) <- c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2', 'Lik.')

p <- mcmc_areas(posterior,
       pars = c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2'),
       prob = 0.8) + plot_title[[i]]

p + geom_segment(aes(x = p_estimate[1], xend = p_estimate[1], y = 8.8, yend = 9.7), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[2], xend = p_estimate[2], y = 7.8, yend = 8.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[3], xend = p_estimate[3], y = 6.8, yend = 7.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[4], xend = p_estimate[4], y = 5.8, yend = 6.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[5], xend = p_estimate[5], y = 4.8, yend = 5.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[6], xend = p_estimate[6], y = 3.8, yend = 4.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[7], xend = p_estimate[7], y = 2.8, yend = 3.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[8], xend = p_estimate[8], y = 1.8, yend = 2.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[9], xend = p_estimate[9], y = .8, yend = 2.1), color = "red", linetype = 2)

```

Figure 7. White-booted racket-tail, no offset information: models fitted with solely presence-only observations are shown as sampled posterior distributions. Models fitted with presence-only and presence-absence observations are shown as point estimates.

```{r posterior predictive distribution 6, echo = FALSE}
## White-booted racket-tail
i=2

posterior <- HB_samples[[i]]
p_estimate <- point_est[[i]]
names(p_estimate) <- NULL
colnames(posterior) <- c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2', 'Lik.')

p <- mcmc_areas(posterior,
       pars = c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2'),
       prob = 0.8) + plot_title[[i]]

p + geom_segment(aes(x = p_estimate[1], xend = p_estimate[1], y = 8.8, yend = 9.7), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[2], xend = p_estimate[2], y = 7.8, yend = 8.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[3], xend = p_estimate[3], y = 6.8, yend = 7.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[4], xend = p_estimate[4], y = 5.8, yend = 6.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[5], xend = p_estimate[5], y = 4.8, yend = 5.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[6], xend = p_estimate[6], y = 3.8, yend = 4.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[7], xend = p_estimate[7], y = 2.8, yend = 3.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[8], xend = p_estimate[8], y = 1.8, yend = 2.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[9], xend = p_estimate[9], y = .8, yend = 2.1), color = "red", linetype = 2)

```

Figure 8. White-booted racket-tail, expert range map: models fitted with solely presence-only observations are shown as sampled posterior distributions. Models fitted with presence-only and presence-absence observations are shown as point estimates.

```{r posterior predictive distribution 7, echo = FALSE}
## White-booted racket-tail
i=3

posterior <- HB_samples[[i]]
p_estimate <- point_est[[i]]
names(p_estimate) <- NULL
colnames(posterior) <- c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2', 'Lik.')

p <- mcmc_areas(posterior,
       pars = c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2'),
       prob = 0.8) + plot_title[[i]]

p + geom_segment(aes(x = p_estimate[1], xend = p_estimate[1], y = 8.8, yend = 9.7), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[2], xend = p_estimate[2], y = 7.8, yend = 8.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[3], xend = p_estimate[3], y = 6.8, yend = 7.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[4], xend = p_estimate[4], y = 5.8, yend = 6.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[5], xend = p_estimate[5], y = 4.8, yend = 5.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[6], xend = p_estimate[6], y = 3.8, yend = 4.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[7], xend = p_estimate[7], y = 2.8, yend = 3.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[8], xend = p_estimate[8], y = 1.8, yend = 2.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[9], xend = p_estimate[9], y = .8, yend = 2.1), color = "red", linetype = 2)

```

Figure 9. White-booted racket-tail, elevation: models fitted with solely presence-only observations are shown as sampled posterior distributions. Models fitted with presence-only and presence-absence observations are shown as point estimates.

```{r posterior predictive distribution 8, echo = FALSE}
## White-booted racket-tail
i=4

posterior <- HB_samples[[i]]
p_estimate <- point_est[[i]]
names(p_estimate) <- NULL
colnames(posterior) <- c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2', 'Lik.')

p <- mcmc_areas(posterior,
       pars = c('Constant', 'Mean temp.', 'Mean diurnal range', 'Precipitation', 'Precip. seasonality', 'Mean temp.^2', 'Mean diurnal range^2', 'Precipitation^2', 'Precip. seasonality^2'),
       prob = 0.8) + plot_title[[i]]

p + geom_segment(aes(x = p_estimate[1], xend = p_estimate[1], y = 8.8, yend = 9.7), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[2], xend = p_estimate[2], y = 7.8, yend = 8.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[3], xend = p_estimate[3], y = 6.8, yend = 7.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[4], xend = p_estimate[4], y = 5.8, yend = 6.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[5], xend = p_estimate[5], y = 4.8, yend = 5.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[6], xend = p_estimate[6], y = 3.8, yend = 4.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[7], xend = p_estimate[7], y = 2.8, yend = 3.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[8], xend = p_estimate[8], y = 1.8, yend = 2.9), color = "red", linetype = 2) +
  geom_segment(aes(x = p_estimate[9], xend = p_estimate[9], y = .8, yend = 2.1), color = "red", linetype = 2)

```

Figure 10. White-booted racket-tail, expert range map and elevation: models fitted with solely presence-only observations are shown as sampled posterior distributions. Models fitted with presence-only and presence-absence observations are shown as point estimates.

### 3.2. Predictive accuracy of the models

I evaluated SDMs with five-fold cross-validation on the presence-only data. Presence-absence data were used as a whole for each fold as training data.

In tables 1 and 2 column "PO" refers to models fitted solely with presence-only data. Column "PO+PA" refers to models fitted jointly with presence-only and presence-absence data.

Table 1. Predictive accuracy of models for marvelous spatuletail
```{r posterior predictive accuracy sp1, echo = FALSE}

auc_hb_sp1 <- matrix(NA, 4, 2)
auc_hb_sp2 <- matrix(NA, 4, 2)

## Marvelous spatuletail
.species <- species_list[1]

#load validation of the full HB
load(paste(.wd, '/Model_fits/', .species, '_validation_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '_m_cat_', 1, '.RData', sep = ''))

auc_hb_sp1[,1] <- diag(predictive_validation$HB_cv_valid$HB_cv_auc)

#load validation of the point estimate
load(paste(.wd, '/Model_fits/', .species, '_validation_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '_m_cat_', 3, '.RData', sep = ''))

auc_hb_sp1[,2] <- diag(predictive_validation$HB_comb_cv_valid$HB_cv_auc)

## White-booted racket-tail
.species <- species_list[2]

#load validation of the full HB
load(paste(.wd, '/Model_fits/', .species, '_validation_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '_m_cat_', 1, '.RData', sep = ''))

auc_hb_sp2[,1] <- diag(predictive_validation$HB_cv_valid$HB_cv_auc)

#load validation of the point estimate
load(paste(.wd, '/Model_fits/', .species, '_validation_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '_m_cat_', 3, '.RData', sep = ''))

auc_hb_sp2[,2] <- diag(predictive_validation$HB_comb_cv_valid$HB_cv_auc)


rownames(auc_hb_sp1) <- c('no offset', 'expert range map', 'elevation', 'map + elevation')
rownames(auc_hb_sp2) <- c('no offset', 'expert range map', 'elevation', 'map + elevation')
colnames(auc_hb_sp1) <- c('PO', 'PO+PA')
colnames(auc_hb_sp2) <- c('PO', 'PO+PA')

kable(round(auc_hb_sp1,3), caption = 'AUC on withheld PO data')
```

Table 2. Predictive accuracy of models for white-booted racket-tail
```{r posterior predictive accuracy sp2, echo = FALSE}
kable(round(auc_hb_sp2,3), caption = 'AUC on withheld PO data')
```


### 3.3. Predictive maps of the models

```{r predictive maps sp1, echo = FALSE}
#Marvelous spatuletail
.species <- species_list[1]

#set scale out according to the target_n_obs
domain_temp <- stack(paste(.wd,"/Data/Domains/", .species, ".tif", sep = ''))
scale_out <- round(sqrt(sum(!is.na(values(domain_temp[[1]])))/target_n_obs))

#Load data
load(paste(.wd, "/Compiled_data/", .species, '_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '.R', sep = ''))

#visualize the species observations and the offsets
#load raster
raster_cov_temp <- stack(paste(.wd,"Data/Environment/Chelsa_SA.tif", sep = '/'))

#load geographic extent
domain_temp <- stack(paste(.wd,"/Data/Domains/", .species, ".tif", sep = ''))

raster_cov_temp <- crop(raster_cov_temp, domain_temp)
values(raster_cov_temp)[is.na(values(domain_temp)[,2]),] <- NA

#rescale raster
raster_cov_temp <- raster::aggregate(raster_cov_temp, fact = scale_out)

#find cells which have all covariate values
cov_df <- as.data.frame(raster_cov_temp, na.rm = FALSE)
rows_na <- apply(cov_df,1,anyNA)
ind_na <- which(rows_na==FALSE)

#create a background
background <- raster_cov_temp$Chelsa_SA.1
values(background)[-ind_na] <- NA

load(paste(.wd, "/Compiled_data/", .species, '_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '.R', sep = ''))

load(paste(.wd, "/Model_fits/", .species, '_fits_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '_m_cat_', 3, '.RData', sep = ''))

#compute thresholds
source(paste(.wd, "/R_code/Plot_thresholds_HB_comb.R", sep = ''))
thres_all <- Plot_thresholds(model_fits, data$training_data, data$offset_full)
thres_temp <- thres_all$TP05

pred_matrix <- cbind(data$pred_data$covariates, data$pred_data$covariates^2)

par(mfrow = c(2,2), cex.main = .7, mai = c(0.1,0.1,0.2,.1))
title_temp <- c("No offset", "Expert range map", "Elevation", "Range map + elevation")
  
for (i in 1:length(model_fits$fit_hb_comb_all)) {
    coeff <- model_fits$fit_hb_comb_all[[i]]$coefficient[-2]
    pred <- matrix(rep(coeff[1], nrow(pred_matrix)), nrow = nrow(pred_matrix), byrow = TRUE) + pred_matrix %*% coeff[-1]
  for (j in i) {
    offset_temp <- log(data$pred_data$offset[[j]][,1]) + log(data$pred_data$offset[[j]][,2])
    mean_pred <- exp(pred + offset_temp)
    values(background)[ind_na] <- log(mean_pred)
    l_pred <- values(background)
    
    #set color scales
    in.max=max(l_pred,na.rm=T)
    in.min=quantile(l_pred,prob=1e-2,na.rm=T)
    
    tmp=quantile(l_pred[l_pred>=thres_temp[i]],seq(0,1,length=50),na.rm=T)
    hb.breaks=c(seq(in.min,thres_temp[i],length=25),tmp)
    values(background)[values(background)<in.min] <- in.min
    mean.col.brk <- hb.breaks
    
    col.brk=data.frame(cols=c(grey(seq(.8,.2,length=24)),
                              colorRampPalette(c("steelblue4", "steelblue1","gold","gold3", "red1", "red4"))(50),NA),
                       breaks=mean.col.brk,stringsAsFactors=F)
    col.brk=col.brk[!duplicated(col.brk$breaks),]
    
    #make sure the top color is red
    col.brk$cols[(nrow(col.brk)-1)]='#8B0000'      
    cex.factor <- 1
    t.ex <- ifelse(is.null(cex.factor),1,cex.factor)*.7
    scaleBarHeight <- .2
    
    #avoid too many legend labels
    lab.breaks.tmp=col.brk$breaks
    keep=round(seq(2,length(lab.breaks.tmp)-1,length=3))
    axis.labs=lab.breaks.tmp[keep]

    
    plot(background, axes = F, box = FALSE, main = title_temp[i], xaxt='n', yaxt='n',
         zlim = c(col.brk$breaks[1],col.brk$breaks[nrow(col.brk)]), col=col.brk$cols[-nrow(col.brk)],
         legend.args=list(text="log(lambda)", line=.2,side=3,cex=.7*t.ex),
         axis.args=list(at=axis.labs, labels=round(axis.labs,2),cex.axis=.8*t.ex),
         breaks=col.brk$breaks, smallplot= c(.72,.74,.03,scaleBarHeight))
    
  }
}

```

Figure 11. Predicted intensities of marvelous spatuletail. Maps are created with different offset information.


```{r predictive maps sp2, echo = FALSE}
#White-booted racket-tail
.species <- species_list[2]

#set scale out according to the target_n_obs
domain_temp <- stack(paste(.wd,"/Data/Domains/", .species, ".tif", sep = ''))
scale_out <- round(sqrt(sum(!is.na(values(domain_temp[[1]])))/target_n_obs))

#Load data
load(paste(.wd, "/Compiled_data/", .species, '_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '.R', sep = ''))

#visualize the species observations and the offsets
#load raster
raster_cov_temp <- stack(paste(.wd,"Data/Environment/Chelsa_SA.tif", sep = '/'))

#load geographic extent
domain_temp <- stack(paste(.wd,"/Data/Domains/", .species, ".tif", sep = ''))

raster_cov_temp <- crop(raster_cov_temp, domain_temp)
values(raster_cov_temp)[is.na(values(domain_temp)[,2]),] <- NA

#rescale raster
raster_cov_temp <- raster::aggregate(raster_cov_temp, fact = scale_out)

#find cells which have all covariate values
cov_df <- as.data.frame(raster_cov_temp, na.rm = FALSE)
rows_na <- apply(cov_df,1,anyNA)
ind_na <- which(rows_na==FALSE)

#create a background
background <- raster_cov_temp$Chelsa_SA.1
values(background)[-ind_na] <- NA

load(paste(.wd, "/Compiled_data/", .species, '_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '.R', sep = ''))

load(paste(.wd, "/Model_fits/", .species, '_fits_', thin_mark, "_quad_n_",
               target_n_obs, "_", weights_mark, '_m_cat_', 3, '.RData', sep = ''))

#compute thresholds
source(paste(.wd, "/R_code/Plot_thresholds_HB_comb.R", sep = ''))
thres_all <- Plot_thresholds(model_fits, data$training_data, data$offset_full)
thres_temp <- thres_all$TP05

pred_matrix <- cbind(data$pred_data$covariates, data$pred_data$covariates^2)

par(mfrow = c(2,2), cex.main = .7, mai = c(0.1,0.1,0.2,.1))
title_temp <- c("No offset", "Expert range map", "Elevation", "Range map + elevation")
  
for (i in 1:length(model_fits$fit_hb_comb_all)) {
    coeff <- model_fits$fit_hb_comb_all[[i]]$coefficient[-2]
    pred <- matrix(rep(coeff[1], nrow(pred_matrix)), nrow = nrow(pred_matrix), byrow = TRUE) + pred_matrix %*% coeff[-1]
  for (j in i) {
    offset_temp <- log(data$pred_data$offset[[j]][,1]) + log(data$pred_data$offset[[j]][,2])
    mean_pred <- exp(pred + offset_temp)
    values(background)[ind_na] <- log(mean_pred)
    l_pred <- values(background)
    
    #set color scales
    in.max=max(l_pred,na.rm=T)
    in.min=quantile(l_pred,prob=1e-2,na.rm=T)
    
    tmp=quantile(l_pred[l_pred>=thres_temp[i]],seq(0,1,length=50),na.rm=T)
    hb.breaks=c(seq(in.min,thres_temp[i],length=25),tmp)
    values(background)[values(background)<in.min] <- in.min
    mean.col.brk <- hb.breaks
    
    col.brk=data.frame(cols=c(grey(seq(.8,.2,length=24)),
                              colorRampPalette(c("steelblue4", "steelblue1","gold","gold3", "red1", "red4"))(50),NA),
                       breaks=mean.col.brk,stringsAsFactors=F)
    col.brk=col.brk[!duplicated(col.brk$breaks),]
    
    #make sure the top color is red
    col.brk$cols[(nrow(col.brk)-1)]='#8B0000'      
    cex.factor <- 1
    t.ex <- ifelse(is.null(cex.factor),1,cex.factor)*.7
    scaleBarHeight <- .2
    
    #avoid too many legend labels
    lab.breaks.tmp=col.brk$breaks
    keep=round(seq(2,length(lab.breaks.tmp)-1,length=3))
    axis.labs=lab.breaks.tmp[keep]

    
    plot(background, axes = F, box = FALSE, main = title_temp[i], xaxt='n', yaxt='n',
         zlim = c(col.brk$breaks[1],col.brk$breaks[nrow(col.brk)]), col=col.brk$cols[-nrow(col.brk)],
         legend.args=list(text="log(lambda)", line=.2,side=3,cex=.7*t.ex),
         axis.args=list(at=axis.labs, labels=round(axis.labs,2),cex.axis=.8*t.ex),
         breaks=col.brk$breaks, smallplot= c(.72,.74,.03,scaleBarHeight))
    
  }
}

```

Figure 12. Predicted intensities of white-booted racket-tail. Maps are created with different offset information.